<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Sudoku3D</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 2em; }
        .result { margin-top: 1em; padding: 1em; border: 1px solid #ccc; background: #f9f9f9; text-align: center; }
        .sudoku-board-container { display: flex; justify-content: center; margin-top: 2em; }
        .sudoku-board { border-collapse: collapse; }
        .sudoku-board td {
            width: 32px; height: 32px; text-align: center; font-size: 1.2em;
            border: 1px solid #888; background: #fff;
            padding: 0;
        }
        .sudoku-board .block-border {
            border-right: 2px solid #222;
        }
        .sudoku-board .row-border {
            border-bottom: 2px solid #222;
        }
        .sudoku-input {
            width: 100%; height: 100%; border: none; text-align: center; font-size: 1.2em; background: none;
        }
        .sudoku-input:disabled {
            background: #eee;
            color: #222;
        }
        .sudoku-error {
            background: #ffcccc !important;
            border: 2px solid #d00 !important;
        }
        .controls { margin-bottom: 1em; display: flex; justify-content: center; gap: 1em; }
        button {
            border-radius: 8px;
            padding: 0.5em 1.2em;
            border: 1px solid #888;
            background: #f0f0f0;
            font-size: 1em;
            cursor: pointer;
            transition: background 0.2s, box-shadow 0.2s;
        }
        button:hover, button:focus {
            background: #e0e0e0;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }
    </style>
</head>
<body>
    <h1 style="text-align:center;">Sudoku3D</h1>
    <form id="generate-form" class="controls">
        <label>Block Size: <input type="number" name="block_size" value="3" min="2" max="5"></label>
        <label>Difficulty:
            <select name="difficulty">
                <option value="1">Easy</option>
                <option value="2" selected>Medium</option>
                <option value="3">Hard</option>
            </select>
        </label>
        <button type="submit">Generate</button>
    </form>
    <form id="sudoku-solve-form" style="display:none;">
        <div class="sudoku-board-container">
            <div id="sudoku-board-container"></div>
        </div>
        <div style="display:flex; justify-content:center;">
            <button type="submit" style="margin-top:1em;">Validate</button>
        </div>
    </form>
    <div id="solve-result" class="result"></div>
    <script>
    let currentBoard = null;
    let currentBlockSize = 3;

    function renderSudokuBoardEditable(board, block_size) {
        if (!board) return '';
        const grid_size = block_size * block_size;
        let html = '<table class="sudoku-board">';
        for (let row = 0; row < grid_size; row++) {
            html += '<tr>';
            for (let col = 0; col < grid_size; col++) {
                const group = Math.floor(col / block_size);
                const index = col % block_size;
                let val = board[row][group][index];
                let isClue = val !== 0;
                html += `<td${(col+1)%block_size===0 && col!==grid_size-1 ? ' class=\"block-border\"' : ''}${(row+1)%block_size===0 && row!==grid_size-1 ? ' class=\"row-border\"' : ''}>` +
                    `<input class="sudoku-input" type="number" min="1" max="${grid_size}" value="${val === 0 ? '' : val}" ${isClue ? 'disabled' : ''} data-row="${row}" data-group="${group}" data-index="${index}">` +
                    `</td>`;
            }
            html += '</tr>';
        }
        html += '</table>';
        return html;
    }

    function findFirstErrorCell(board, block_size) {
        const grid_size = block_size * block_size;
        for (let row = 0; row < grid_size; row++) {
            let seen = new Set();
            for (let col = 0; col < grid_size; col++) {
                const group = Math.floor(col / block_size);
                const index = col % block_size;
                let val = board[row][group][index];
                if (val === 0) continue;
                if (seen.has(val)) return {row, col};
                seen.add(val);
            }
        }
        for (let col = 0; col < grid_size; col++) {
            let seen = new Set();
            for (let row = 0; row < grid_size; row++) {
                const group = Math.floor(col / block_size);
                const index = col % block_size;
                let val = board[row][group][index];
                if (val === 0) continue;
                if (seen.has(val)) return {row, col};
                seen.add(val);
            }
        }
        for (let boxRow = 0; boxRow < block_size; boxRow++) {
            for (let boxCol = 0; boxCol < block_size; boxCol++) {
                let seen = new Set();
                for (let r = 0; r < block_size; r++) {
                    for (let c = 0; c < block_size; c++) {
                        let row = boxRow * block_size + r;
                        let col = boxCol * block_size + c;
                        const group = Math.floor(col / block_size);
                        const index = col % block_size;
                        let val = board[row][group][index];
                        if (val === 0) continue;
                        if (seen.has(val)) return {row, col};
                        seen.add(val);
                    }
                }
            }
        }
        return null;
    }

    document.getElementById('generate-form').onsubmit = async function(e) {
        e.preventDefault();
        const block_size = parseInt(this.block_size.value);
        const difficulty = parseInt(this.difficulty.value);
        const res = await fetch('/generate', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ block_size, difficulty })
        });
        const data = await res.json();
        if (data.board) {
            currentBoard = data.board;
            currentBlockSize = block_size;
            document.getElementById('sudoku-board-container').innerHTML = renderSudokuBoardEditable(data.board, block_size);
            document.getElementById('sudoku-solve-form').style.display = '';
            document.getElementById('solve-result').textContent = '';
        } else {
            document.getElementById('sudoku-board-container').innerHTML = '';
            document.getElementById('sudoku-solve-form').style.display = 'none';
        }
    };

    document.getElementById('sudoku-solve-form').onsubmit = async function(e) {
        e.preventDefault();
        if (!currentBoard) return;
        document.querySelectorAll('.sudoku-input').forEach(input => input.classList.remove('sudoku-error'));
        let board = JSON.parse(JSON.stringify(currentBoard));
        const grid_size = currentBlockSize * currentBlockSize;
        document.querySelectorAll('.sudoku-input').forEach(input => {
            const row = parseInt(input.dataset.row);
            const group = parseInt(input.dataset.group);
            const index = parseInt(input.dataset.index);
            let val = parseInt(input.value);
            board[row][group][index] = isNaN(val) ? 0 : val;
        });
        const res = await fetch('/validate', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ block_size: currentBlockSize, board })
        });
        const data = await res.json();
        if (data.valid) {
            document.getElementById('solve-result').textContent = '✅ Correct Solution!';
        } else {
            const err = findFirstErrorCell(board, currentBlockSize);
            if (err) {
                document.getElementById('solve-result').textContent = `❌ Not a valid solution. Error at row ${err.row+1}, col ${err.col+1}`;
                document.querySelectorAll('.sudoku-input').forEach(input => {
                    if (parseInt(input.dataset.row) === err.row && parseInt(input.dataset.group)*currentBlockSize+parseInt(input.dataset.index) === err.col) {
                        input.classList.add('sudoku-error');
                        input.scrollIntoView({behavior:'smooth', block:'center'});
                    }
                });
            } else {
                document.getElementById('solve-result').textContent = '❌ Not a valid solution.';
            }
        }
    };
    </script>
</body>
</html> 